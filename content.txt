import tkinter as tk
from tkinter import filedialog, messagebox
from PIL import Image, ImageTk
import os
import random
import array
import pyperclip
import time
import webbrowser
import subprocess
import uuid
import requests
from dateutil.relativedelta import relativedelta
from datetime import datetime, timezone, timedelta
#La version ha sido instalada, lo hemos logrado caballeros
# Variables globales
nombre_archivo = None
extension_archivo = None
contenido_bytes = None
original = list(range(256))
antiguo = None
llaves = []
rutaSemillas = ""
# =========================
# Funciones de desorden
# =========================
def desorden():
    global original
    semilla = semillaInput.get() or "default"
    random.seed(semilla)
    copia = original.copy()
    random.shuffle(copia)
    return copia

def desorden2():
    global original
    obtieneSemilla = ""
    with open("vlauni.prtt", "r") as f:
        obtieneSemilla = f.read()
    semilla = obtieneSemilla
    random.seed(semilla)
    copia = original.copy()
    random.shuffle(copia)
    return copia


# =========================
# Funciones de archivos
# =========================
def seleccionar_archivo(ruta = "0", ruta_guardado = "0"):
    global nombre_archivo, extension_archivo, contenido_bytes, antiguo
    copia = None
    pide = 0

    if(ruta == "0"):
        ruta = filedialog.askopenfilename()
        pide += 1
    if not ruta:
        return
    nombre_archivo = os.path.splitext(os.path.basename(ruta))[0]
    extension_archivo = os.path.splitext(ruta)[1]
    
    nombreCompleto = nombre_archivo + extension_archivo + "\n"
    binario = list(nombreCompleto.encode("utf-8"))

    try:
        with open(ruta, "rb") as f:
            contenido_bytes = list(f.read())
            antiguo = contenido_bytes
        label_info.config(text=f"Archivo leído: {nombre_archivo}{extension_archivo} ({len(contenido_bytes)} bytes)")
        copia = desorden()

        cadenaCambiada = array.array('B', binario)
        for i in contenido_bytes:
            resultado = copia[i]
            cadenaCambiada.append(resultado)

        contenido = cadenaCambiada.tobytes()

        if(ruta_guardado == "0"):
            ruta_guardado = filedialog.asksaveasfilename(
                defaultextension=".prt",
                filetypes=[("Archivos protektor", "*.prt")],
                title="Guardar archivo protegido"
            )
        
        with open(ruta_guardado, "wb") as f:
            f.write(contenido)
            messagebox.showinfo("Proceso", "¡Se completó con éxito!")
    except Exception as e:
        messagebox.showerror("Error", f"No se pudo leer el archivo:\n{e}")

def reconstruir_archivo(ruta = "0"):
    global nombre_archivo, extension_archivo, contenido_bytes, antiguo
    copia = desorden()
    tipo = ruta
    if(ruta == "0"):
        ruta = filedialog.askopenfilename(
            title="Selecciona un archivo protektor",
            filetypes=[("Archivos protektor", "*.prt")]
        )
    if not ruta:
        return

    try:
        with open(ruta, "rb") as f:
            contenido_bytes = list(f.read())
            
        indice = contenido_bytes.index(10)
        nombre_archivo = contenido_bytes[:indice]
        contenidoRecuperado = contenido_bytes[indice + 1:]

        solo_directorio = os.path.dirname(ruta)
        if(tipo != "0"):
            directorio_padre = os.path.dirname(solo_directorio)
            solo_directorio = os.path.join(directorio_padre, "Recuperados")
        texto = bytes(nombre_archivo).decode("utf-8")
        directorioCompleto = os.path.join(solo_directorio, texto)

        contenidoOriginal = array.array("B",[])
        for o in contenidoRecuperado:
            resulta = copia.index(o)
            contenidoOriginal.append(resulta)
            
        contenidoFinal = contenidoOriginal.tobytes()
        
        with open(directorioCompleto, "wb") as f:
            f.write(contenidoFinal)
            messagebox.showinfo("Proceso", "¡Se completó con éxito!")
    except Exception as e:
        messagebox.showerror("Error", f"No se pudo guardar el archivo:\n{e}")
        print(e)
def seleccionar_archivos():
    rutas = filedialog.askopenfilenames()
    contadorN = 0
    if not rutas:
        return
    base = filedialog.askdirectory(title="Selecciona dónde guardaras los archivos")
    if base:
        nueva = os.path.join(base, "Archivos Generados")
        os.mkdir(nueva)
        rutaContrasenas = os.path.join(nueva, "Contraseñas")
        os.mkdir(rutaContrasenas)
        rutaArchivos = os.path.join(nueva, "Archivos")
        os.mkdir(rutaArchivos)

        nombreContra = os.path.join(rutaContrasenas, "Contraseñas")
    for ruta in rutas:
        timestamp = time.time() + contadorN
        random.seed(timestamp)
        longitud = random.randint(20, 100)
        caracteres = "0123456789abcdefghijklmnñopqrstuvwxyzABCDEFGHIJKLMNÑOPQRSTUVWXYZ"
        codigo = "".join(random.choice(caracteres) for _ in range(longitud))

        semillaInput.delete(0, tk.END)
        semillaInput.insert(0, codigo)
        name = os.path.splitext(os.path.basename(ruta))[0]
        nameC = name +".sprt" 
        name = name + ".prt"
        nombreArch = os.path.join(rutaArchivos, name)
        seleccionar_archivo(ruta, nombreArch)
        contadorN += 1

        nombreContra = os.path.join(rutaContrasenas, nameC)
        GuardarSemilla(nombreContra)
        messagebox.showinfo("Proceso", "¡Se completó con éxito!")
def reconstruir_archivos():
    messagebox.showinfo("Abrir Carpetas a decodificar", "Selecciona la carpeta (Archivos Generados) que tiene dentro: \n 1- La carpeta contraseña (Con las contraseñas a usar) \n 2- La carpeta Archivos (Con los archivos a usar)")
    ruta = filedialog.askdirectory()
    rutaContras = os.path.join(ruta, "Contraseñas")#ruta de carpeta de contraseñas, para agarrar de base
    rutaArchis = os.path.join(ruta, "Archivos")
    recuperados = os.path.join(ruta, "Recuperados")
    os.makedirs(recuperados, exist_ok=True)
    if rutaContras:
        contrasSPRT = [f for f in os.listdir(rutaContras) if f.endswith(".sprt")]
        for passw in contrasSPRT:
            ruta_completa = os.path.join(rutaContras, passw)
            copiarLlave(ruta_completa,"1")
            try:
                nombreArchivoSeleccionado = os.path.splitext(passw)[0]
                nombreArchivo = os.path.join(rutaArchis, nombreArchivoSeleccionado) + ".prt"
                reconstruir_archivo(nombreArchivo)
                messagebox.showinfo("Proceso", "¡Se completó con éxito!")
            except Exception as e:
                messagebox.showerror("Error", f"Error: {e}")
    
    #seleccionar los archivos
    #seleccionar las contraseñas
    #obtener la contraseña, pegarla en el input de semilla
    #y el archivo con el mismo nombre decodificarlo con esa semilla

# =========================
# Funciones de llaves y contraseñas
# =========================
def GuardarSemilla(rutaGuarda = "0"):
    copia = desorden2()
    claveSemilla = semillaInput.get().replace(" ", "_")
    if(rutaGuarda == "0"):
        rutaGuarda = filedialog.asksaveasfilename(
            defaultextension=".sprt",
            filetypes=[("Archivos protektor", "*.sprt")],
            title="Guardar archivo protegido"
        )
    texto = list(claveSemilla.encode('utf-8'))
    contenido = array.array("B",[])
    for i in texto:
        resultado = copia[i]
        contenido.append(resultado)
    with open(rutaGuarda, "wb") as f:
        f.write(contenido)
        messagebox.showinfo("Proceso", "¡Se completó con éxito!")


def buscaSemilla():
    carpeta = filedialog.askdirectory()
    if carpeta:
        mostrar_botones(carpeta, ".sprt")
def mostrar_botones(ruta, extension):
    global llaves, rutaSemillas
    llaves = []
    rutaSemillas = ruta + "/"
    # Limpiar el frame
    for widget in frame_botones.winfo_children():
        widget.destroy()

    archivos = [f for f in os.listdir(ruta) if f.endswith(extension)]

    for archivo in archivos:
        boton = tk.Button(frame_botones, text=archivo, width=40, command=lambda nombre=archivo: copiarLlave(nombre))
        boton.pack(pady=2, padx=5)

def copiarLlave(nombre, tipo = "0"):
    global rutaSemillas
    copia = desorden2()
    rutaSemillas1 = ""
    if(tipo == "0"):
        rutaSemillas1 = rutaSemillas + nombre
    if(tipo == "1"):
        rutaSemillas1 = nombre
    with open(rutaSemillas1, "rb") as f:
        contenido = f.read()
    listaEnteros = list(contenido)
    original = array.array("B",[])
        
    for o in listaEnteros:
        resulta = copia.index(o)
        original.append(resulta)
    texto_bytes = bytes(original)

    # Decodificar con UTF-8
    texto = texto_bytes.decode('utf-8')

    if(tipo == "0"):
        pyperclip.copy(texto)
        messagebox.showinfo("Copiar texto", "¡Se copió!")
    if(tipo == "1"):
        semillaInput.delete(0, tk.END)
        semillaInput.insert(0, texto)

def buscaContraseña():
    carpeta = filedialog.askdirectory()
    if carpeta:
        mostrarContraseñas(carpeta, ".cprt")

def mostrarContraseñas(ruta, extension):
    global llaves, rutaSemillas
    llaves = []
    rutaSemillas = ruta + "/"
    # Limpiar el frame
    for widget in frame_botones.winfo_children():
        widget.destroy()

    archivos = [f for f in os.listdir(ruta) if f.endswith(extension)]

    for archivo in archivos:
        boton = tk.Button(frame_botones, text=archivo, width=40, command=lambda nombre=archivo: copiarContra(nombre))
        boton.pack(pady=2, padx=5)
def copiarContra(nombre):
    global rutaSemillas
    copia = desorden()
    rutaSemillas1 = rutaSemillas + nombre
    with open(rutaSemillas1, "rb") as f:
        contenido = f.read()
    listaEnteros = list(contenido)
    original = array.array("B",[])
        
    for o in listaEnteros:
        resulta = copia.index(o)
        original.append(resulta)
    texto_bytes = bytes(original)

    # Decodificar con UTF-8
    texto = texto_bytes.decode('utf-8')

    pyperclip.copy(texto)
    messagebox.showinfo("Copiar texto", "¡Se copió!")
    

def solo_numeros(valor):
    return valor.isdigit() or valor == ""

def generarContras():
    # 1. Obtener la semilla desde el entry
    semilla_texto = semillaInput.get()
    if semilla_texto.strip() == "":
        semilla_texto = "default"  # si no hay semilla, usa algo por defecto

    # Usar la semilla para inicializar el generador
    random.seed(semilla_texto)

    # 2. Obtener los caracteres permitidos
    letras = letrasUsar.get()
    numeros = numerosUsar.get()
    simbolos = simbolosUsar.get()

    # 3. Obtener mínimos y máximos
    min_letras = int(minLetras.get())
    max_letras = int(maxLetras.get())
    min_numeros = int(minnumeros.get())
    max_numeros = int(maxnumeros.get())
    min_simbolos = int(minsimbolos.get())
    max_simbolos = int(maxsimbolos.get())

    # 4. Obtener tamaño total
    tam_total = int(tamanioComtra.get())

    # 5. Generar cantidades aleatorias dentro de los rangos
    cant_letras = random.randint(min_letras, max_letras)
    cant_numeros = random.randint(min_numeros, max_numeros)
    cant_simbolos = random.randint(min_simbolos, max_simbolos)

    # Ajustar si la suma excede el tamaño total
    suma = cant_letras + cant_numeros + cant_simbolos
    if suma > tam_total:
        # recortar proporcionalmente
        exceso = suma - tam_total
        while exceso > 0:
            if cant_letras > min_letras:
                cant_letras -= 1
                exceso -= 1
            elif cant_numeros > min_numeros:
                cant_numeros -= 1
                exceso -= 1
            elif cant_simbolos > min_simbolos:
                cant_simbolos -= 1
                exceso -= 1
    elif suma < tam_total:
        # rellenar con letras (o cualquier categoría)
        resta_letras = max_letras - cant_letras
        cant_letras = cant_letras + resta_letras
        resta_numeros = max_numeros - cant_numeros
        cant_numeros = cant_numeros + resta_numeros
        resta_simbolos = max_simbolos - cant_simbolos
        cant_simbolos = cant_simbolos + resta_simbolos

    # 6. Construir la contraseña
    password_chars = []
    password_chars += random.sample(letras, min(cant_letras, len(letras)))
    password_chars += random.sample(numeros, min(cant_numeros, len(numeros)))
    password_chars += random.sample(simbolos, min(cant_simbolos, len(simbolos)))

    # Si aún falta por llegar al tamaño total, rellenar con cualquier conjunto
    pool = ""
    while len(password_chars) < tam_total:
        if (max_letras - min_letras) > 0 or (max_letras == 1 and min_letras == 1):
            pool = pool + letras
        if (max_numeros - min_numeros) > 0 or (max_numeros == 1 and min_numeros == 1):
            pool = pool + numeros
        if (max_simbolos - min_simbolos) > 0 or (max_simbolos == 1 and min_simbolos == 1):
            pool = pool + simbolos
        password_chars.append(random.choice(pool))

    # Mezclar para que no quede ordenado
    random.shuffle(password_chars)

    password = "".join(password_chars)
    contraMuestra.delete(0, tk.END)
    contraMuestra.insert(0, password)

def contraGuarda():
    copia = desorden()
    contraObtenida = contraMuestra.get()
    rutaGuarda = filedialog.asksaveasfilename(
        defaultextension=".cprt",  # extensión por defecto
        filetypes=[("Archivos protektor", "*.cprt")],
        title="Guardar archivo protegido"
        )
    texto = list(contraObtenida.encode('utf-8'))
    contenido = array.array("B",[])
    for i in texto:
        resultado = copia[i]
        contenido.append(resultado)
    #print(f"clave: {claveSemilla} \n texto: {texto}\n contenido: {contenido} \n copia: {copia}")
    with open(rutaGuarda, "wb") as f:
        f.write(contenido)
        messagebox.showinfo("Proceso", "¡Se completó con éxito!")
    
def verArchivos():
    archivosCifrar.grid()
    #TextoCifrar.grid_remove()
    #contrasenaGenerar.grid_remove()
    #ajustes.grid_remove()
    contraseñaInfo.grid_remove()
    tablaParte.grid_remove()
    contraGenera.grid_remove()
    contraMuestra.grid_remove()
    guardaContra.grid_remove()
    seleccionarArchivosMultiples.grid_remove()
    reconstruyeMultiple.grid_remove()
    btn_seleccionar.grid()
    btn_reconstruir.grid()
    label.grid()
    semillaInput.grid()
    guardarSemilla.grid()
    label_info.grid()
    automatizaInfo.grid_remove()
    ajustes.grid_remove()

def verAutomatico():
    archivosCifrar.grid()
    seleccionarArchivosMultiples.grid()
    reconstruyeMultiple.grid()
    contraseñaInfo.grid_remove()
    tablaParte.grid_remove()
    contraGenera.grid_remove()
    contraMuestra.grid_remove()
    guardaContra.grid_remove()
    label.grid()
    semillaInput.grid()
    guardarSemilla.grid_remove()
    btn_seleccionar.grid()
    btn_reconstruir.grid()
    label_info.grid_remove()
    automatizaInfo.grid()
    ajustes.grid_remove()

def verContraseña():
    archivosCifrar.grid()
    tablaParte.grid()
    contraseñaInfo.grid()
    contraGenera.grid()
    contraMuestra.grid()
    guardaContra.grid()
    btn_seleccionar.grid_remove()
    btn_reconstruir.grid_remove()
    seleccionarArchivosMultiples.grid_remove()
    reconstruyeMultiple.grid_remove()
    label.grid()
    semillaInput.grid()
    guardarSemilla.grid()
    label_info.grid_remove()
    automatizaInfo.grid_remove()
    #TextoCifrar.grid_remove()
    #contrasenaGenerar.grid()
    ajustes.grid_remove()

def verTutoriales():
    archivosCifrar.grid_remove()
    ajustes.grid()

# ========================
# Parte de botones sociales
# ========================

def copiarcorreo():
    pyperclip.copy("relavius@hotmail.com")
    messagebox.showinfo("Copiar texto", "¡Se copió!")
def copiarfacebook():
    webbrowser.open("https://www.facebook.com/share/p/1A1ckbVd5D/")
def copiarinsta():
    webbrowser.open("https://www.instagram.com/progra_mador?igsh=b3gyOTI1Z3kzNnZp")
def copiarthreads():
    webbrowser.open("https://www.threads.com/@progra_mador")
def copiartiktok():
    webbrowser.open("http://tiktok.com/@sapitodev")
def copiartelegram():
    webbrowser.open("https://t.me/melariusApps")
def copiartwit():
    webbrowser.open("https://x.com/MELARIUS279545?t=l1F1ySE1UqcVv5binzy1rg&s=08")
def copiaryt():
    webbrowser.open("https://youtube.com/@melarius-app?si=5Zlh4Ug1O98gdHvu")

#==========================================================================================================================
#==========================================================================================================================
#==========================================================================================================================
def CompruebaVersion():
    with open("hetx.prtt", "r") as f:
        version = f.read()
    url = "https://raw.githubusercontent.com/rMELARIUSr/proteje/main/version.txt"
    resp = requests.get(url)
    if resp.status_code == 200:
        contenido = resp.text
        print(f"Contenido del archivo:{contenido}, version: {version}")
        if(contenido != version):
            url2 = "https://raw.githubusercontent.com/rMELARIUSr/proteje/main/content.txt"
            resp2 = requests.get(url2)
            if resp2.status_code == 200:
                contenido2 = resp2.text
                with open("cryptoGrafo.py", "w", encoding="utf-8") as f:
                    f.write(contenido2)
        with open("hetx.prtt", "w") as f:
            f.write(contenido)
    else:
        print("Error al acceder al archivo:", resp.status_code)
    CompruebaKey()

def orden(texto):#Lo devuelve
    obtieneSemilla = ""
    with open("vlauni.prtt", "r") as f:
        obtieneSemilla = f.read()
    random.seed(obtieneSemilla)
    frase = list("0123456789abcdefghijklmnñopqrstuvwxyzABCDEFGHIJKLMNÑOPQRSTUVWXYZ-/_")
    desfrase = frase.copy()
    random.shuffle(desfrase)

    palabra = list(texto)
    termina = ""
    for i in palabra:
        g = desfrase.index(i)
        nuevaLetra = frase[g]
        termina = termina + nuevaLetra
    return termina
    
def desorden(texto):#Lo trangiversa
    obtieneSemilla = ""
    with open("vlauni.prtt", "r") as f:
        obtieneSemilla = f.read()
    random.seed(obtieneSemilla)
    frase = list("0123456789abcdefghijklmnñopqrstuvwxyzABCDEFGHIJKLMNÑOPQRSTUVWXYZ-/_")
    desfrase = frase.copy()
    random.shuffle(desfrase)

    palabra = list(texto)
    termina = ""
    for i in palabra:
        g = frase.index(i)
        nuevaLetra = desfrase[g]
        termina = termina + nuevaLetra
    return termina
    

def desalocar(palabra):
    semilla = "sa21fs5d87d54gd524j5k4j24j2h14554fd45hy4m54jyhkj8u7k58jju52f4df14df5ds85ds45r56153y1jjm4ju984m56j1mu35lkuio54li561"
    random.seed(semilla)
    frase = list("0123456789abcdefghijklmnñopqrstuvwxyzABCDEFGHIJKLMNÑOPQRSTUVWXYZ-/_")
    desfrase = frase.copy()
    random.shuffle(desfrase)

    palabra = list(palabra)
    termina = ""
    for i in palabra:
        g = desfrase.index(i)
        nuevaLetra = frase[g]
        termina = termina + nuevaLetra
    print(f"llave de licencia: {termina}")
    return termina



def CompruebaKey():
    #Si no hay key, entonces se abre la interfaz grafica
    #Si hay key, entonces comprueba que lo que tiene la key concuerda con los datos del sistema, si no concuerda, borra la key que tiene y muestra la interfaz
    linea = ""
    archiv = "xqtsbc.prtt"
    if(os.path.exists(archiv) and os.path.getsize(archiv) != 0):
        with open("xqtsbc.prtt", "r", encoding="utf-8") as f:
            linea = f.readline().strip()
        for i in range(3):
            linea = orden(linea)
        
        enRegla = 0

        separaLinea = linea.split("_")
        parteLicencia = separaLinea[0]
        parteMac = separaLinea[1]
        parteUUID = separaLinea[2]
        parteProduct = separaLinea[3]

        mac = uuid.getnode()#bien
        mac = hex(mac)

        output = subprocess.check_output("wmic csproduct get uuid", shell=True).decode()
        lineas = [line.strip() for line in output.splitlines() if line.strip()]
        uuid1 = lineas[1]

        output2 = subprocess.check_output("wmic os get SerialNumber", shell=True).decode()
        lineas2 = [line2.strip() for line2 in output2.splitlines() if line2.strip()]
        product_id = lineas2[1]

        if(parteMac == mac):
            enRegla += 1
        if(parteUUID == uuid1):
            enRegla += 1
        if(parteProduct == product_id):
            enRegla += 1
        
        separaValor = parteLicencia.split("-")
        procede = checaHora(separaValor,"1")
        if(procede >= 1):
            enRegla += 1
        if(enRegla >= 3):
            protektor.destroy()
            contenedorLog.grid_remove()
            contnedorApp.grid()
    else:
        textoKey.grid()
        botoncito.grid()

def checaHora(separaValor, web = "0"):
    # 1. Hora UTC del computador
    hora_pc = datetime.now(timezone.utc)
    print("Hora UTC del PC:", hora_pc)

    print(f"separaV: {separaValor}")
    fechaInicio = separaValor[0]
    fechaLimite = separaValor[1]
    hastaCuando = separaValor[2]
    tipoLlave = separaValor[3]

    # 2. Hora UTC de un servidor externo (WorldTimeAPI)
    try:
        resp = requests.get("http://worldtimeapi.org/api/timezone/Etc/UTC")
        data = resp.json()
        hora_servidor = datetime.fromisoformat(data["utc_datetime"].replace("Z", "+00:00"))
        print("Hora UTC del servidor:", hora_servidor)
    except Exception as e:
        messagebox.showinfo("Error al validar Licencia", "Debes conectarte a internet")
        hora_servidor = None

    # 3. Comparar ambas horas con tolerancia de 30 minutos
    if(hora_servidor == None and web == "1"):
        hora_servidor = hora_pc
    if hora_servidor:
        diferencia = abs(hora_pc - hora_servidor)
        if diferencia <= timedelta(minutes=120):
            print("La hora del PC está dentro del rango permitido.")
            
            # 4. Convertir tu texto a datetime y comparar con la hora del PC
            
            partesIni = list(map(int, fechaInicio.split("/")))
            anio, mes, dia, hora, minuto, segundo, microsegundo = partesIni
            fechaIni = datetime(anio, mes, dia, hora, minuto, segundo, microsegundo, tzinfo=timezone.utc)

            partesLim = list(map(int, fechaLimite.split("/")))
            anio, mes, dia, hora, minuto, segundo, microsegundo = partesLim
            fechaLim = datetime(anio, mes, dia, hora, minuto, segundo, microsegundo, tzinfo=timezone.utc)

            partesCua = list(map(int, hastaCuando.split("/")))
            anio, mes, dia, hora, minuto, segundo, microsegundo = partesCua
            fechaCua = datetime(anio, mes, dia, hora, minuto, segundo, microsegundo, tzinfo=timezone.utc)

            if(hora_pc > fechaIni and fechaLim > hora_pc ):
                diff = relativedelta(fechaCua, fechaIni)
                procede = 0
                if diff.years == 1 and diff.months == 0 and diff.days == 0 and tipoLlave == "ULTA":
                    procede += 1
                elif diff.months == 1 and diff.years == 0 and diff.days == 0 and tipoLlave == "ULTM":
                    procede += 1
                elif diff.days == 2 and diff.months == 0 and diff.years == 0 and tipoLlave == "ULPP":
                    archivoPrueba = "whfkr.prtt"
                    if not os.path.exists(archivoPrueba):
                        with open(archivoPrueba, "w", encoding="utf-8") as f:
                            f.write("1")
                        procede += 1
                    else:
                        messagebox.showinfo("Licencia", "Parece ser que ya usaste tu licencia de prueba")
                elif diff.years == 100 and diff.months == 0 and diff.days == 0 and tipoLlave == "ULTT":
                    procede += 1
            else:
                messagebox.showinfo("Hora desincronizada", "Parece ser que usaste tu licencia fuera del rango del tiempo")
        else:
            messagebox.showinfo("Hora desincronizada", "Configura bien tu hora \n si el problema persiste, contacta al vendedor")
    return procede
def ValidaKey():
    #se ingresa key por que no hay y se comprueba que es valida
    valor = entrada.get()
    value = desalocar(valor)
    separaValor = value.split("-")
    # ====================
    # Analizar valor y ver que todo este en orden
    # ====================


    procede = checaHora(separaValor,"1")

    if(procede >= 1):
        mac = uuid.getnode()
        mac = hex(mac)

        output = subprocess.check_output("wmic csproduct get uuid", shell=True).decode()
        lineas = [line.strip() for line in output.splitlines() if line.strip()]
        uuid1 = lineas[1]

        product_id = subprocess.check_output("wmic os get SerialNumber", shell=True)
        product_id = product_id.decode().strip()

        fraseFinal = value + "_" + mac + "_" + uuid1 + "_" + product_id
        random.seed(fraseFinal)
        longitud = random.randint(20, 100)
        palabrasLlaves = "0123456789abcdefghijklmnñopqrstuvwxyzABCDEFGHIJKLMNÑOPQRSTUVWXYZ"
        llaveGeneralDeUso = "".join(random.choice(palabrasLlaves) for _ in range(longitud))

        archivoLlave = "vlauni.prtt"

        if not os.path.exists(archivoLlave) or os.path.getsize(archivoLlave) == 0:
            with open(archivoLlave, "w", encoding="utf-8") as f:
                f.write(llaveGeneralDeUso)

        for i in range(3):
            fraseFinal = desorden(fraseFinal)
        with open("xqtsbc.prtt", "w", encoding="utf-8") as q:
            q.write(fraseFinal)
        CompruebaKey()
    if(procede == 0):
        messagebox.showinfo("Licencia", "Licencia no válida")


#==========================================================================================================================
#==========================================================================================================================
#==========================================================================================================================

# Interfaz gráfica

protektor = tk.Tk()
protektor.title("Protector")
protektor.configure(bg="#002041")
protektor.iconbitmap("iconos/logoPrt.ico")

#login===============================================================================

contenedorLog = tk.Frame(protektor, bg="#002041", relief="groove", bd=3)
contenedorLog.grid(row=0, column=0, padx=3, pady=5)

imagenParte = tk.Frame(contenedorLog, bg="#002041", relief="groove", bd=3)
imagenParte.grid(row=0, column=0, padx=3, pady=5)

# --- Imagen ---
imagen = Image.open("iconos/logoPrt.jpg")   # tu imagen
imagen = imagen.resize((350, 350), Image.Resampling.LANCZOS)
img_tk = ImageTk.PhotoImage(imagen)

label_img = tk.Label(imagenParte, image=img_tk, bg="#002041")
label_img.grid(row=0, column=0, padx=3, pady=5)

textoKey = tk.Frame(contenedorLog, bg="#002041", relief="groove", bd=3)
textoKey.grid(row=1, column=0, padx=3, pady=5)
textoKey.grid_remove()
# --- Label ---
label_texto = tk.Label(textoKey, text="Ingrese su dato:", fg="white", bg="#002041", font=("Arial", 12))
label_texto.grid(row=0, column=0, padx=3, pady=5)

# --- Entry ---
entrada = tk.Entry(textoKey, width=30)
entrada.grid(row=0, column=1, padx=3, pady=5)

# --- Botón ---
botoncito = tk.Frame(contenedorLog, bg="#002041", relief="groove", bd=3)
botoncito.grid(row=2, column=0, padx=3, pady=5)
botoncito.grid_remove()

boton = tk.Button(botoncito, text="Aceptar", command=ValidaKey, bg="#004080", fg="white")
boton.grid(row=0, column=0, padx=3, pady=5)

protektor.after(0, CompruebaVersion)

# fin Login ======================================================================

# =========================
# Estilos
# =========================
btn_style = {
    "bg": "#c7823d",
    "fg": "white",
    "font": ("Arial", 11, "bold"),
    "relief": "raised",
    "bd": 2,
    "activebackground": "#86592d",
    "activeforeground": "white",
    "width": 18,
    "height": 2
}

label_style = {"bg": "#002041", "fg": "white", "font": ("Arial", 10)}
entry_style = {"bg": "white", "fg": "black", "font": ("Arial", 10)}

contnedorApp = tk.Frame(protektor, bg="#002041")
contnedorApp.grid(row=0, padx=10, pady=10)
contnedorApp.grid_remove()

# =========================
# Barra de opciones
# =========================
barraOpciones = tk.Frame(contnedorApp, bg="#002041")
barraOpciones.grid(row=0, padx=10, pady=10)

vistaArchivos = tk.Button(barraOpciones, text="Cifrar Archivos", command=verArchivos, **btn_style)
vistaArchivos.grid(row=0, column=0, padx=5, pady=5)

vistaContrasena = tk.Button(barraOpciones, text="Generar Contraseña", command=verContraseña, **btn_style)
vistaContrasena.grid(row=0, column=1, padx=5, pady=5)

automatizar = tk.Button(barraOpciones, text="Automatizar", command=verAutomatico, **btn_style)
automatizar.grid(row=0, column=2, padx=5, pady=5)

tutoriales = tk.Button(barraOpciones, text="Tutoriales", command=verTutoriales, **btn_style)
tutoriales.grid(row=0, column=3, padx=5, pady=5)

# =========================
# Sección Archivos
# =========================
archivosCifrar = tk.Frame(contnedorApp, bg="#002041", relief="groove", bd=3)
archivosCifrar.grid(row=1, padx=10, pady=10, sticky="nsew")

contenedor1 = tk.Frame(archivosCifrar, bg="#002041")
contenedor1.grid(row=0, column=0, padx=10, pady=10)

parteAnuncio = tk.Frame(contenedor1, bg="#002041")
parteAnuncio.grid(row=0, padx=10, pady=10)

label_info = tk.Label(parteAnuncio, text="1- Ingresa una llave y guardala \n2- Selecciona un botón según lo desees \n3- Escoge un archivo y donde guardarlo", **label_style)
label_info.grid(row=0, column=0, padx=5, pady=5)

contraseñaInfo = tk.Label(parteAnuncio, text="1- Ingresa los caracteres a usar \n2- Ingresa una llave y guardala \n3- Selecciona la cantidad de letras, números y símbolos \n4- Selecciona el tamaño de la contraseña \n5- Genera y guarda tu contraseña y tu llave", **label_style)
contraseñaInfo.grid(row=0, column=0, padx=5, pady=5)
contraseñaInfo.grid_remove()

automatizaInfo = tk.Label(parteAnuncio, text="1- selecciona los archivos a codificar \n2- Las llaves serán generadas al azar \n3- Las llaves y los archivos tendrán el mismo nombre \n4- Para decodificar los archivos, debes seleccionar las llaves \n y los archivos, ambos con el mismo nombre", **label_style)
automatizaInfo.grid(row=0, column=0, padx=5, pady=5)
automatizaInfo.grid_remove()

# =========================
# Parte Trabajo
# =========================
parteTrabajo = tk.Frame(contenedor1, bg="#002041", relief="ridge", bd=2)
parteTrabajo.grid(row=1, padx=10, pady=10)

semillaParte = tk.Frame(parteTrabajo, bg="#002041")
semillaParte.grid(row=0, column=0, padx=5, pady=5)

label = tk.Label(semillaParte, text="Ingresa la llave:", **label_style)
label.grid(row=1, column=0, padx=5, pady=5)

semillaInput = tk.Entry(semillaParte, **entry_style)
semillaInput.grid(row=1, column=1, padx=5, pady=5)

# =========================
# Tabla Contraseña
# =========================
tablaParte = tk.Frame(parteTrabajo, bg="#002041", relief="ridge", bd=2)
tablaParte.grid(row=1, column=0, padx=5, pady=5)
tablaParte.grid_remove()

tituloColumna1 = tk.Label(tablaParte, text="Caracteres", **label_style)
tituloColumna1.grid(row=0, column=1, padx=5, pady=5)

tituloColumna2 = tk.Label(tablaParte, text="Min", **label_style)
tituloColumna2.grid(row=0, column=2, padx=5, pady=5)

tituloColumna3 = tk.Label(tablaParte, text="Max", **label_style)
tituloColumna3.grid(row=0, column=3, padx=5, pady=5)

tituloFila1 = tk.Label(tablaParte, text="Letras", **label_style)
tituloFila1.grid(row=1, column=0, padx=5, pady=5)

tituloFila2 = tk.Label(tablaParte, text="Números", **label_style)
tituloFila2.grid(row=2, column=0, padx=5, pady=5)

tituloFila3 = tk.Label(tablaParte, text="Símbolos", **label_style)
tituloFila3.grid(row=3, column=0, padx=5, pady=5)

tituloFila4 = tk.Label(tablaParte, text="Tamaño de\ncontraseña", **label_style)
tituloFila4.grid(row=4, column=1, padx=5, pady=5)

validacion = tablaParte.register(solo_numeros)

tamanioComtra = tk.Entry(tablaParte, **entry_style, validate="key", validatecommand=(validacion, "%P"))
tamanioComtra.grid(row=4, column=2, padx=5, pady=5)
tamanioComtra.insert(0, "10")

letrasUsar = tk.Entry(tablaParte, **entry_style)
letrasUsar.grid(row=1, column=1, padx=5, pady=5)
letrasUsar.insert(0, "abcdefghijklmnñopqrstuvwxyzABCDEFGHIJKLMNÑOPQRSTUVWXYZ")

minLetras = tk.Entry(tablaParte, **entry_style, validate="key", validatecommand=(validacion, "%P"))
minLetras.grid(row=1, column=2, padx=5, pady=5)
minLetras.insert(0, "8")

maxLetras = tk.Entry(tablaParte, **entry_style, validate="key", validatecommand=(validacion, "%P"))
maxLetras.grid(row=1, column=3, padx=5, pady=5)
maxLetras.insert(0, "15")

numerosUsar = tk.Entry(tablaParte, **entry_style)
numerosUsar.grid(row=2, column=1, padx=5, pady=5)
numerosUsar.insert(0, "0123456789")

minnumeros = tk.Entry(tablaParte, **entry_style, validate="key", validatecommand=(validacion, "%P"))
minnumeros.grid(row=2, column=2, padx=5, pady=5)
minnumeros.insert(0, "1")

maxnumeros = tk.Entry(tablaParte, **entry_style, validate="key", validatecommand=(validacion, "%P"))
maxnumeros.grid(row=2, column=3, padx=5, pady=5)
maxnumeros.insert(0, "5")

simbolosUsar = tk.Entry(tablaParte, **entry_style)
simbolosUsar.grid(row=3, column=1, padx=5, pady=5)
simbolosUsar.insert(0, "/*#$&_-")

minsimbolos = tk.Entry(tablaParte, **entry_style, validate="key", validatecommand=(validacion, "%P"))
minsimbolos.grid(row=3, column=2, padx=5, pady=5)
minsimbolos.insert(0, "1")

maxsimbolos = tk.Entry(tablaParte, **entry_style, validate="key", validatecommand=(validacion, "%P"))
maxsimbolos.grid(row=3, column=3, padx=5, pady=5)
maxsimbolos.insert(0, "5")

# =========================
# Botones de acción
# =========================
parteBotones = tk.Frame(parteTrabajo, bg="#002041")
parteBotones.grid(row=2, column=0, padx=5, pady=5)

guardarSemilla = tk.Button(parteBotones, text="Guardar Llave", command=GuardarSemilla, **btn_style)
guardarSemilla.grid(row=2, column=0, padx=5, pady=5)

btn_seleccionar = tk.Button(parteBotones, text="Codificar archivo", command=seleccionar_archivo, **btn_style)
btn_seleccionar.grid(row=3, column=0, padx=5, pady=5)

btn_reconstruir = tk.Button(parteBotones, text="Decodificar archivo", command=reconstruir_archivo, **btn_style)
btn_reconstruir.grid(row=3, column=1, padx=5, pady=5)

seleccionarArchivosMultiples = tk.Button(parteBotones, text="Codificar archivos", command=seleccionar_archivos, **btn_style)
seleccionarArchivosMultiples.grid(row=3, column=0, padx=5, pady=5)
seleccionarArchivosMultiples.grid_remove()

reconstruyeMultiple = tk.Button(parteBotones, text="Decodificar archivos", command=reconstruir_archivos, **btn_style)
reconstruyeMultiple.grid(row=3, column=1, padx=5, pady=5)
reconstruyeMultiple.grid_remove()

contraGenera = tk.Button(parteBotones, text="Generar Contraseña", command=generarContras, **btn_style)
contraGenera.grid(row=1, column=0, padx=5, pady=5)
contraGenera.grid_remove()

contraMuestra = tk.Entry(parteBotones, **entry_style)
contraMuestra.grid(row=1, column=1, padx=5, pady=5)
contraMuestra.grid_remove()

guardaContra = tk.Button(parteBotones, text="Guardar Contraseña", command=contraGuarda, **btn_style)
guardaContra.grid(row=2, column=1, padx=5, pady=5)
guardaContra.grid_remove()
                   
# =========================
# Contenedor 2 (busca semillas y contraseñas)
# =========================
contenedor2 = tk.Frame(archivosCifrar, bg="#002041", relief="groove", bd=3)
contenedor2.grid(row=0, column=1, padx=10, pady=10)

indicaciones = tk.Frame(contenedor2, bg="#002041")
indicaciones.grid(row=0, column=0, padx=10, pady=10)

labe2 = tk.Label(indicaciones, text="1- Selecciona una ubicación \n2- Presiona un botón para copiar la Llave \n3- Pégala en el campo de texto \n**Los archivos no deben contener espacios**", **label_style)
labe2.grid(row=0, column=0, padx=5, pady=5)

botoncitos = tk.Frame(indicaciones, bg="#002041")
botoncitos.grid(row=1, column=0, padx=5, pady=5)

botonBuscarSemilla = tk.Button(botoncitos, text="Buscar Llave", command=buscaSemilla, **btn_style)
botonBuscarSemilla.grid(row=0, column=0, padx=5, pady=5)

botonBuscarContrasena = tk.Button(botoncitos, text="Buscar Contraseña", command=buscaContraseña, **btn_style)
botonBuscarContrasena.grid(row=0, column=1, padx=5, pady=5)

# =========================
# Área de botones con scroll
# =========================
botonesArea = tk.Frame(contenedor2, bg="#002041")
botonesArea.grid(row=1, column=0, padx=5, pady=5)

canvas = tk.Canvas(botonesArea, bg="#002041", highlightthickness=0)
scrollbar = tk.Scrollbar(botonesArea, orient="vertical", command=canvas.yview)
frame_botones = tk.Frame(canvas, bg="#002041")

frame_botones.bind(
    "<Configure>",
    lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
)

canvas.create_window((0, 0), window=frame_botones, anchor="nw")
canvas.configure(yscrollcommand=scrollbar.set)

canvas.pack(side="left", fill="both", expand=True)
scrollbar.pack(side="right", fill="y")

# =========================
# Frames adicionales
# =========================
contrasenaGenerar = tk.Frame(contnedorApp, bg="#002041", relief="groove", bd=3)
contrasenaGenerar.grid(row=1, padx=10, pady=10)
contrasenaGenerar.grid_remove()

ajustes = tk.Frame(contnedorApp, bg="#002041", relief="groove", bd=3)
ajustes.grid(row=1, padx=10, pady=10)
ajustes.grid_remove()

imagen1 = Image.open("iconos/imgCOR.jpg")
w1, h1 = imagen1.size
recorte_w1 = int(w1 * 0.1)
recorte_h1 = int(h1 * 0.1)
caja1 = (recorte_w1, recorte_h1, w1 - recorte_w1, h1 - recorte_h1)
recortada1 = imagen1.crop(caja1)
imagen1D = recortada1.resize((200, 200), Image.Resampling.LANCZOS)
icono1 = ImageTk.PhotoImage(imagen1D)
correo = tk.Button(ajustes, image=icono1, command=copiarcorreo, borderwidth=0, highlightthickness=0)
correo.grid(row=0, column=0, padx=3, pady=5)

imagen2 = Image.open("iconos/imgFB.jpg")
w2, h2 = imagen2.size
recorte_w2 = int(w2 * 0.1)
recorte_h2 = int(h2 * 0.1)
caja2 = (recorte_w2, recorte_h2, w2 - recorte_w2, h2 - recorte_h2)
recortada2 = imagen2.crop(caja2)
imagen2D = recortada2.resize((200, 200), Image.Resampling.LANCZOS)
icono2 = ImageTk.PhotoImage(imagen2D)
facebook = tk.Button(ajustes, image=icono2, command=copiarfacebook, borderwidth=0, highlightthickness=0)
facebook.grid(row=0, column=1, padx=3, pady=5)

imagen3 = Image.open("iconos/imgIG.jpg")
w3, h3 = imagen3.size
recorte_w3 = int(w3 * 0.1)
recorte_h3 = int(h3 * 0.1)
caja3 = (recorte_w3, recorte_h3, w3 - recorte_w3, h3 - recorte_h3)
recortada3 = imagen3.crop(caja3)
imagen3D = recortada3.resize((200, 200), Image.Resampling.LANCZOS)
icono3 = ImageTk.PhotoImage(imagen3D)
insta = tk.Button(ajustes, image=icono3, command=copiarinsta, borderwidth=0, highlightthickness=0)
insta.grid(row=0, column=2, padx=3, pady=5)

imagen4 = Image.open("iconos/imgTHR.jpg")
w4, h4 = imagen4.size
recorte_w4 = int(w4 * 0.1)
recorte_h4 = int(h4 * 0.1)
caja4 = (recorte_w4, recorte_h4, w4 - recorte_w4, h4 - recorte_h4)
recortada4 = imagen4.crop(caja4)
imagen4D = recortada4.resize((200, 200), Image.Resampling.LANCZOS)
icono4 = ImageTk.PhotoImage(imagen4D)
threads = tk.Button(ajustes, image=icono4, command=copiarthreads, borderwidth=0, highlightthickness=0)
threads.grid(row=0, column=3, padx=3, pady=5)

imagen5 = Image.open("iconos/imgTK.jpg")
w5, h5 = imagen5.size
recorte_w5 = int(w5 * 0.1)
recorte_h5 = int(h5 * 0.1)
caja5 = (recorte_w5, recorte_h5, w5 - recorte_w5, h5 - recorte_h5)
recortada5 = imagen5.crop(caja5)
imagen5D = recortada5.resize((200, 200), Image.Resampling.LANCZOS)
icono5 = ImageTk.PhotoImage(imagen5D)
tiktok = tk.Button(ajustes, image=icono5, command=copiartiktok, borderwidth=0, highlightthickness=0)
tiktok.grid(row=1, column=0, padx=3, pady=5)

imagen6 = Image.open("iconos/imgTL.jpg")
w6, h6 = imagen6.size
recorte_w6 = int(w6 * 0.1)
recorte_h6 = int(h6 * 0.1)
caja6 = (recorte_w6, recorte_h6, w6 - recorte_w6, h6 - recorte_h6)
recortada6 = imagen6.crop(caja6)
imagen6D = recortada6.resize((200, 200), Image.Resampling.LANCZOS)
icono6 = ImageTk.PhotoImage(imagen6D)
telegram = tk.Button(ajustes, image=icono6, command=copiartelegram, borderwidth=0, highlightthickness=0)
telegram.grid(row=1, column=1, padx=3, pady=5)

imagen7 = Image.open("iconos/imgX.jpg")
w7, h7 = imagen7.size
recorte_w7 = int(w7 * 0.1)
recorte_h7 = int(h7 * 0.1)
caja7 = (recorte_w7, recorte_h7, w7 - recorte_w7, h7 - recorte_h7)
recortada7 = imagen7.crop(caja7)
imagen7D = recortada7.resize((200, 200), Image.Resampling.LANCZOS)
icono7 = ImageTk.PhotoImage(imagen7D)
twit = tk.Button(ajustes, image=icono7, command=copiartwit, borderwidth=0, highlightthickness=0)
twit.grid(row=1, column=2, padx=3, pady=5)

imagen8 = Image.open("iconos/imgYT.jpg")
w8, h8 = imagen8.size
recorte_w8 = int(w8 * 0.1)
recorte_h8 = int(h8 * 0.1)
caja8 = (recorte_w8, recorte_h8, w8 - recorte_w8, h8 - recorte_h8)
recortada8 = imagen8.crop(caja8)
imagen8D = recortada8.resize((200, 200), Image.Resampling.LANCZOS)
icono8 = ImageTk.PhotoImage(imagen8D)
yt = tk.Button(ajustes, image=icono8, command=copiaryt, borderwidth=0, highlightthickness=0)
yt.grid(row=1, column=3, padx=3, pady=5)


redes = tk.Frame(contnedorApp, bg="#002041", relief="groove", bd=3)
redes.grid(row=2, padx=10, pady=10)

# =========================
# Mainloop
# =========================
protektor.mainloop()
